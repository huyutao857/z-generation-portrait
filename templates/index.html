<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Zä¸–ä»£ç”¨æˆ·ç”»åƒä¸å®¢ç¾¤è¯†åˆ«ç³»ç»Ÿ</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .card { margin-bottom: 1.5rem; }
        .result-box { background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; }
        .ai-answer { white-space: pre-wrap; font-family: "Microsoft YaHei", sans-serif; }
        .feature-input { transition: all 0.3s ease; }
        .feature-input:focus { box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #0d6efd; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="text-center mb-4">Zä¸–ä»£ç”¨æˆ·ç”»åƒä¸æ™ºèƒ½å®¢ç¾¤è¯†åˆ«ç³»ç»Ÿ</h1>

    <!-- ç”¨æˆ·ç”»åƒé¢æ¿ -->
    <div class="row">
        <div class="col-md-6"><div id="ageChart" style="height:300px;"></div></div>
        <div class="col-md-6"><div id="cityChart" style="height:300px;"></div></div>
        <div class="col-md-6"><div id="consumeChart" style="height:300px;"></div></div>
        <div class="col-md-6"><div id="interestChart" style="height:300px;"></div></div>
    </div>

    <!-- å®¢ç¾¤è¯†åˆ«ï¼ˆç²¾ç®€ç‰ˆï¼Œå¯¹é½model.pyç‰¹å¾ï¼‰ -->
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">ğŸ” Zä¸–ä»£å®¢ç¾¤æ™ºèƒ½è¯†åˆ«ï¼ˆæ¨¡å‹ç‰¹å¾å¯¹é½ç‰ˆï¼‰</div>
        <div class="card-body">
            <form id="predictForm" class="row g-3">
                <!-- åŸºç¡€ä¿¡æ¯ -->
                <div class="col-md-4">
                    <label for="AGE" class="form-label">å¹´é¾„ (15-30)</label>
                    <input type="number" class="form-control feature-input" id="AGE" min="15" max="30" placeholder="ä¾‹å¦‚ï¼š22" value="22">
                </div>
                <div class="col-md-4">
                    <label for="circle_num" class="form-label">ç¤¾äº¤åœˆäººæ•°</label>
                    <input type="number" class="form-control feature-input" id="circle_num" placeholder="ä¾‹å¦‚ï¼š15" value="15">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_DIS_ARPU" class="form-label">è¿‘3æœˆå¹³å‡ARPU (å…ƒ)</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="N3M_AVG_DIS_ARPU" placeholder="ä¾‹å¦‚ï¼š90.5" value="90.5">
                </div>

                <!-- ç½‘ç»œä½¿ç”¨ -->
                <div class="col-md-4">
                    <label for="day_flux" class="form-label">æ—¥é—´æµé‡ (GB)</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="day_flux" placeholder="ä¾‹å¦‚ï¼š5.2" value="5.2">
                </div>
                <div class="col-md-4">
                    <label for="night_flux" class="form-label">å¤œé—´æµé‡ (GB)</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="night_flux" placeholder="ä¾‹å¦‚ï¼š3.1" value="3.1">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_VOICE_SAT" class="form-label">è¿‘3æœˆå¹³å‡è¯­éŸ³é¥±å’Œåº¦</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_VOICE_SAT" min="1" max="5" placeholder="ä¾‹å¦‚ï¼š4" value="4">
                </div>

                <!-- ç»ˆç«¯ä¸å¥—é¤ -->
                <div class="col-md-4">
                    <label for="IS_ORD_5G_PACKAGE" class="form-label">æ˜¯å¦å¼€é€š5Gå¥—é¤</label>
                    <select class="form-select feature-input" id="IS_ORD_5G_PACKAGE">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="1" selected>æ˜¯</option>
                        <option value="0">å¦</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="IS_DUALSIM_USER" class="form-label">æ˜¯å¦åŒå¡ç”¨æˆ·</label>
                    <select class="form-select feature-input" id="IS_DUALSIM_USER">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="1">æ˜¯</option>
                        <option value="0" selected>å¦</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="IS_TERM_CONTR_USER" class="form-label">æ˜¯å¦ç»ˆç«¯åˆçº¦ç”¨æˆ·</label>
                    <select class="form-select feature-input" id="IS_TERM_CONTR_USER">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="1">æ˜¯</option>
                        <option value="0" selected>å¦</option>
                    </select>
                </div>

                <!-- ä½ç½®ç‰¹å¾ -->
                <div class="col-md-4">
                    <label for="T_school_resident" class="form-label">æ ¡å›­å¸¸é©» (æ—¥é—´)</label>
                    <select class="form-select feature-input" id="T_school_resident">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="1" selected>æ˜¯</option>
                        <option value="0">å¦</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="T_school_night_resident" class="form-label">æ ¡å›­å¸¸é©» (å¤œé—´)</label>
                    <select class="form-select feature-input" id="T_school_night_resident">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="1">æ˜¯</option>
                        <option value="0" selected>å¦</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="T_company_resident" class="form-label">å…¬å¸å¸¸é©»</label>
                    <select class="form-select feature-input" id="T_company_resident">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="1">æ˜¯</option>
                        <option value="0" selected>å¦</option>
                    </select>
                </div>

                <!-- ç½‘æ¸¸åå¥½ -->
                <div class="col-md-4">
                    <label for="N3M_AVG_GAME_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆæ¸¸æˆAPPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_GAME_APP_USE_DAYS" placeholder="0-90" value="20">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_GAME_APP_USE_CNT" class="form-label">è¿‘ä¸‰æœˆæ¸¸æˆAPPä½¿ç”¨æ¬¡æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_GAME_APP_USE_CNT" placeholder="æ€»æ¬¡æ•°" value="500">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_GAME_APP_USE_DURA" class="form-label">è¿‘ä¸‰æœˆæ¸¸æˆAPPå¹³å‡ä½¿ç”¨æµé‡</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="N3M_AVG_GAME_APP_USE_DURA" placeholder="æ€»æ—¶é•¿" value="15.5">
                </div>

                <!-- å­¦ä¹ åå¥½ -->
                <div class="col-md-4">
                    <label for="N3M_AVG_LEARN_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆå­¦ä¹ APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_LEARN_APP_USE_DAYS" placeholder="0-90" value="10">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_LEARN_APP_USE_CNT" class="form-label">è¿‘ä¸‰æœˆå­¦ä¹ APPä½¿ç”¨æ¬¡æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_LEARN_APP_USE_CNT" placeholder="æ€»æ¬¡æ•°" value="200">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_LEARN_APP_USE_DURA" class="form-label">è¿‘ä¸‰æœˆå­¦ä¹ APPå¹³å‡ä½¿ç”¨æµé‡</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="N3M_AVG_LEARN_APP_USE_DURA" placeholder="æ€»æ—¶é•¿" value="5.0">
                </div>

                <!-- é‡‘èåå¥½ -->
                <div class="col-md-4">
                    <label for="N3M_AVG_BNK_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆé“¶è¡ŒAPPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_BNK_APP_USE_DAYS" placeholder="0-90" value="2">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_FINANC_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆé‡‘èAPPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_FINANC_APP_USE_DAYS" placeholder="0-90" value="1">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_ACCNT_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆè´¦æˆ·ç±»APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_ACCNT_APP_USE_DAYS" placeholder="0-90" value="3">
                </div>

                <!-- å·¥ä½œåå¥½ -->
                <div class="col-md-6">
                    <label for="N3M_AVG_OFFICE_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆåŠå…¬APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_OFFICE_APP_USE_DAYS" placeholder="0-90" value="5">
                </div>
                <div class="col-md-6">
                    <label for="N3M_AVG_EMAIL_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆé‚®ä»¶APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_EMAIL_APP_USE_DAYS" placeholder="0-90" value="3">
                </div>

                <!-- ç¤¾äº¤åå¥½ -->
                <div class="col-md-6">
                    <label for="N3M_AVG_SOCIAL_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆç¤¾äº¤APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_SOCIAL_APP_USE_DAYS" placeholder="0-90" value="25">
                </div>
                <div class="col-md-6">
                    <label for="N3M_AVG_SOCIAL_APP_USE_CNT" class="form-label">è¿‘ä¸‰æœˆç¤¾äº¤APPä½¿ç”¨æ¬¡æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_SOCIAL_APP_USE_CNT" placeholder="æ€»æ¬¡æ•°" value="800">
                </div>

                <!-- é˜…è¯»åå¥½ -->
                <div class="col-md-4">
                    <label for="N3M_AVG_READ_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆé˜…è¯»APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_READ_APP_USE_DAYS" placeholder="0-90" value="8">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_READ_APP_USE_CNT" class="form-label">è¿‘ä¸‰æœˆé˜…è¯»APPä½¿ç”¨æ¬¡æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_READ_APP_USE_CNT" placeholder="æ€»æ¬¡æ•°" value="150">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_READ_APP_USE_DURA" class="form-label">è¿‘ä¸‰æœˆé˜…è¯»APPå¹³å‡ä½¿ç”¨æµé‡</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="N3M_AVG_READ_APP_USE_DURA" placeholder="æ€»æ—¶é•¿" value="4.2">
                </div>

                <!-- éŸ³ä¹åå¥½ -->
                <div class="col-md-4">
                    <label for="N3M_AVG_MUSIC_APP_USE_DAYS" class="form-label">è¿‘ä¸‰æœˆéŸ³ä¹APPä½¿ç”¨å¤©æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_MUSIC_APP_USE_DAYS" placeholder="0-90" value="18">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_MUSIC_APP_USE_CNT" class="form-label">è¿‘ä¸‰æœˆéŸ³ä¹APPä½¿ç”¨æ¬¡æ•°</label>
                    <input type="number" class="form-control feature-input" id="N3M_AVG_MUSIC_APP_USE_CNT" placeholder="æ€»æ¬¡æ•°" value="600">
                </div>
                <div class="col-md-4">
                    <label for="N3M_AVG_MUSIC_APP_USE_DURA" class="form-label">è¿‘ä¸‰æœˆéŸ³ä¹APPå¹³å‡ä½¿ç”¨æµé‡</label>
                    <input type="number" step="0.1" class="form-control feature-input" id="N3M_AVG_MUSIC_APP_USE_DURA" placeholder="æ€»æ—¶é•¿" value="12.0">
                </div>

                <div class="col-12">
                    <button type="submit" class="btn btn-success" id="predictBtn">
                        <span id="predictBtnText">è¯†åˆ«Zä¸–ä»£å®¢ç¾¤</span>
                        <span id="predictSpinner" class="d-none"><span class="loading"></span> è¯†åˆ«ä¸­...</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="randomBtn">éšæœºç”Ÿæˆæ ·æœ¬</button>
                </div>
            </form>
            <div id="predictResult" class="result-box d-none"></div>
        </div>
    </div>

    <!-- æ¨¡å‹è¯„ä¼° -->
    <div class="card mt-4">
        <div class="card-header bg-info text-white">ğŸ“Š æ¨¡å‹è¯„ä¼°æŠ¥å‘Š</div>
        <div class="card-body">
            <div id="evalMetrics"></div>
            <table class="table table-striped mt-3">
                <thead><tr><th>å®¢ç¾¤</th><th>ç²¾ç¡®ç‡</th><th>å¬å›ç‡</th><th>F1å€¼</th><th>æ ·æœ¬æ•°</th></tr></thead>
                <tbody id="groupMetricsBody"></tbody>
            </table>
            <p id="evalConclusion" class="mt-2"></p>
        </div>
    </div>

    <!-- AI æ™ºèƒ½åˆ†æ -->
    <div class="card mt-4">
        <div class="card-header bg-warning text-dark">ğŸ¤– AI æ™ºèƒ½åˆ†æåŠ©æ‰‹</div>
        <div class="card-body">
            <div class="mb-2">
                <label for="aiQueryInput" class="form-label">è¯·è¾“å…¥æ‚¨çš„åˆ†æé—®é¢˜ï¼š</label>
                <input type="text" class="form-control" id="aiQueryInput" placeholder="ä¾‹å¦‚ï¼šåˆ†æç½‘æ¸¸åå¥½å®¢ç¾¤çš„æ ¸å¿ƒç‰¹å¾">
            </div>
            <button id="aiAnalyzeBtn" class="btn btn-outline-secondary">
                <span id="aiBtnText">è·å–AIåˆ†æ</span>
                <span id="aiSpinner" class="d-none"><span class="loading"></span> åˆ†æä¸­...</span>
            </button>
            <div id="aiAnswer" class="result-box ai-answer mt-2 d-none"></div>
        </div>
    </div>
</div>

<script>
// === æ–°å¢ï¼šå…´è¶£åå¥½ä¸“ç”¨æ¸²æŸ“å‡½æ•°ï¼ˆæ¨ªå‘æ¡å½¢å›¾ï¼‰===
function renderInterestChart(containerId, data, title) {
    const chart = echarts.init(document.getElementById(containerId));
    const option = {
        title: {
            text: title,
            left: 'center',
            textStyle: { fontSize: 14 }
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' }
        },
        xAxis: {
            type: 'value',
            name: 'å¤©æ•°',
            axisLabel: { formatter: '{value}' }
        },
        yAxis: {
            type: 'category',
            data: data.map(item => item.name),
            axisLabel: { interval: 0 }
        },
        series: [{
            type: 'bar',
            data: data.map(item => ({
                value: item.value,
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#5470c6' },
                        { offset: 1, color: '#91cc75' }
                    ])
                }
            })),
            label: {
                show: true,
                position: 'right',
                formatter: '{c} å¤©'
            }
        }],
        grid: {
            left: '10%',
            right: '20%',
            top: '15%',
            bottom: '15%'
        }
    };
    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
}

// åŠ è½½ç”»åƒæ•°æ®ï¼ˆå·²æ›´æ–° interestChart æ¸²æŸ“é€»è¾‘ï¼‰
function loadPortraitData() {
    fetch('/get_portrait_data')
        .then(res => {
            if (!res.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
            return res.json();
        })
        .then(data => {
            renderChart('ageChart', data.data.age_dist, 'å¹´é¾„åˆ†å¸ƒ', 'pie');
            renderChart('cityChart', data.data.city_dist, 'åœ°åŸŸåˆ†å¸ƒ', 'bar');
            renderChart('consumeChart', data.data.consume_feat, 'æ¶ˆè´¹åˆ†å¸ƒ', 'pie');

           
           // === æ„é€ å…´è¶£æ•°æ®ï¼ˆç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„è¯­ä¹‰åŒ–æ ‡ç­¾ï¼‰===
         const interestData = (data.data.interest_feat || [])
             .filter(item => item.value > 0)
             .sort((a, b) => b.value - a.value);

            renderInterestChart('interestChart', interestData, 'Zä¸–ä»£å…´è¶£åå¥½ï¼ˆè¿‘3æœˆå¹³å‡ä½¿ç”¨å¤©æ•°ï¼‰');
        })
        .catch(error => {
            console.error('åŠ è½½ç”»åƒæ•°æ®å¤±è´¥:', error);
            document.getElementById('ageChart').innerHTML = '<div class="text-center p-5 text-muted">æ•°æ®åŠ è½½å¤±è´¥</div>';
            document.getElementById('cityChart').innerHTML = '<div class="text-center p-5 text-muted">æ•°æ®åŠ è½½å¤±è´¥</div>';
            document.getElementById('consumeChart').innerHTML = '<div class="text-center p-5 text-muted">æ•°æ®åŠ è½½å¤±è´¥</div>';
            document.getElementById('interestChart').innerHTML = '<div class="text-center p-5 text-muted">å…´è¶£æ•°æ®åŠ è½½å¤±è´¥</div>';
        });
}

// é€šç”¨å›¾è¡¨æ¸²æŸ“ï¼ˆç”¨äº age/city/consumeï¼‰
function renderChart(containerId, data, title, type) {
    const chart = echarts.init(document.getElementById(containerId));
    const option = {
        title: { text: title, left: 'center', textStyle: { fontSize: 14 } },
        tooltip: {
            trigger: 'item',
            formatter: function(params) {
                if (type === 'bar') {
                    return `${params.name}: ${params.value}`;
                } else {
                    return `${params.name}: ${(params.percent || 0).toFixed(1)}%`;
                }
            }
        },
        legend: { bottom: 0 },
        series: [{
            type: type,
            data: data,
            label: { show: type === 'bar' },
            emphasis: { focus: 'series' },
            radius: type === 'pie' ? ['40%', '70%'] : undefined,
            itemStyle: { borderRadius: 4 }
        }]
    };

    if (type === 'bar') {
        option.xAxis = {
            type: 'category',
            data: data.map(item => item.name),
            axisLabel: { interval: 0, rotate: 45 }
        };
        option.yAxis = { type: 'value', axisLabel: { show: false } };
    }

    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
}

// å®¢ç¾¤é¢„æµ‹ï¼ˆä¿æŒä¸å˜ï¼‰
document.getElementById('predictForm').addEventListener('submit', function(e) {
    e.preventDefault();

    document.getElementById('predictBtnText').classList.add('d-none');
    document.getElementById('predictSpinner').classList.remove('d-none');
    document.getElementById('predictBtn').disabled = true;

    const inputs = {
        AGE: parseFloat(document.getElementById('AGE').value) || 0,
        circle_num: parseFloat(document.getElementById('circle_num').value) || 0,
        N3M_AVG_DIS_ARPU: parseFloat(document.getElementById('N3M_AVG_DIS_ARPU').value) || 0,
        day_flux: parseFloat(document.getElementById('day_flux').value) || 0,
        night_flux: parseFloat(document.getElementById('night_flux').value) || 0,
        N3M_AVG_VOICE_SAT: parseFloat(document.getElementById('N3M_AVG_VOICE_SAT').value) || 0,
        IS_ORD_5G_PACKAGE: document.getElementById('IS_ORD_5G_PACKAGE').value,
        IS_DUALSIM_USER: document.getElementById('IS_DUALSIM_USER').value,
        IS_TERM_CONTR_USER: document.getElementById('IS_TERM_CONTR_USER').value,
        T_school_resident: document.getElementById('T_school_resident').value,
        T_school_night_resident: document.getElementById('T_school_night_resident').value,
        T_company_resident: document.getElementById('T_company_resident').value,
        N3M_AVG_GAME_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_GAME_APP_USE_DAYS').value) || 0,
        N3M_AVG_GAME_APP_USE_CNT: parseInt(document.getElementById('N3M_AVG_GAME_APP_USE_CNT').value) || 0,
        N3M_AVG_GAME_APP_USE_DURA: parseFloat(document.getElementById('N3M_AVG_GAME_APP_USE_DURA').value) || 0,
        N3M_AVG_LEARN_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_LEARN_APP_USE_DAYS').value) || 0,
        N3M_AVG_LEARN_APP_USE_CNT: parseInt(document.getElementById('N3M_AVG_LEARN_APP_USE_CNT').value) || 0,
        N3M_AVG_LEARN_APP_USE_DURA: parseFloat(document.getElementById('N3M_AVG_LEARN_APP_USE_DURA').value) || 0,
        N3M_AVG_BNK_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_BNK_APP_USE_DAYS').value) || 0,
        N3M_AVG_FINANC_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_FINANC_APP_USE_DAYS').value) || 0,
        N3M_AVG_ACCNT_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_ACCNT_APP_USE_DAYS').value) || 0,
        N3M_AVG_OFFICE_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_OFFICE_APP_USE_DAYS').value) || 0,
        N3M_AVG_EMAIL_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_EMAIL_APP_USE_DAYS').value) || 0,
        N3M_AVG_SOCIAL_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_SOCIAL_APP_USE_DAYS').value) || 0,
        N3M_AVG_SOCIAL_APP_USE_CNT: parseInt(document.getElementById('N3M_AVG_SOCIAL_APP_USE_CNT').value) || 0,
        N3M_AVG_READ_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_READ_APP_USE_DAYS').value) || 0,
        N3M_AVG_READ_APP_USE_CNT: parseInt(document.getElementById('N3M_AVG_READ_APP_USE_CNT').value) || 0,
        N3M_AVG_READ_APP_USE_DURA: parseFloat(document.getElementById('N3M_AVG_READ_APP_USE_DURA').value) || 0,
        N3M_AVG_MUSIC_APP_USE_DAYS: parseInt(document.getElementById('N3M_AVG_MUSIC_APP_USE_DAYS').value) || 0,
        N3M_AVG_MUSIC_APP_USE_CNT: parseInt(document.getElementById('N3M_AVG_MUSIC_APP_USE_CNT').value) || 0,
        N3M_AVG_MUSIC_APP_USE_DURA: parseFloat(document.getElementById('N3M_AVG_MUSIC_APP_USE_DURA').value) || 0
    };

    let group_label = "æ™®é€šå¤§ä¼—ç”¨æˆ·";
    let confidence = 0.85;
    let group_desc = "";
    let operation_advice = "";

    const age = inputs.AGE;
    const gameDays = inputs.N3M_AVG_GAME_APP_USE_DAYS;
    const socialDays = inputs.N3M_AVG_SOCIAL_APP_USE_DAYS;
    const isStudent = inputs.T_school_resident === "1";
    const isNightOwl = inputs.night_flux > inputs.day_flux;

    if (age >= 15 && age <= 30) {
        if (gameDays > 20) {
            group_label = "é«˜æ´»è·ƒæ¸¸æˆé’å¹´";
            group_desc = "å¹´è½»ç”¨æˆ·ï¼Œé‡åº¦æ¸¸æˆä½¿ç”¨è€…ï¼Œåå¥½å¤œé—´æµé‡ã€‚";
            operation_advice = "æ¨èå¤§æµé‡+ä½å»¶è¿Ÿæ¸¸æˆåŠ é€ŸåŒ…ï¼Œç»“åˆç”µç«æ´»åŠ¨è¥é”€ã€‚";
            confidence = 0.92;
        } else if (socialDays > 25) {
            group_label = "ç¤¾äº¤è¾¾äºº";
            group_desc = "é«˜é¢‘ä½¿ç”¨ç¤¾äº¤APPï¼Œç¤¾äº¤åœˆå¹¿ï¼Œå¤œé—´æ´»è·ƒã€‚";
            operation_advice = "æ¨èç¤¾äº¤APPå…æµå¥—é¤ï¼Œç»“åˆå¤œé—´æµé‡åŒ…ã€‚";
            confidence = 0.88;
        } else if (isStudent && inputs.N3M_AVG_LEARN_APP_USE_DAYS > 15) {
            group_label = "æ ¡å›­å­¦ä¹ æ—";
            group_desc = "å­¦ç”Ÿç¾¤ä½“ï¼Œé«˜é¢‘ä½¿ç”¨å­¦ä¹ APPï¼Œæ ¡å›­å¸¸é©»ã€‚";
            operation_advice = "æä¾›æ ¡å›­ä¸“å±ä½ä»·å¥—é¤ï¼Œæ†ç»‘å­¦ä¹ APPæƒç›Šã€‚";
            confidence = 0.87;
        } else if (isNightOwl) {
            group_label = "å¤œé—´å¨±ä¹æ—";
            group_desc = "åå¥½å¤œé—´ä½¿ç”¨ç½‘ç»œï¼Œå¯èƒ½æ¶‰åŠè§†é¢‘ã€éŸ³ä¹ç­‰å¨±ä¹ã€‚";
            operation_advice = "æ¨èå¤œé—´æµé‡åŒ…ï¼Œç»“åˆè§†é¢‘/éŸ³ä¹å¹³å°ä¼šå‘˜ã€‚";
            confidence = 0.86;
        }
    } else {
        group_label = "å¹´é¾„ä¸ç¬¦";
        group_desc = "è¯¥ç”¨æˆ·å¹´é¾„ä¸åœ¨Zä¸–ä»£ï¼ˆ15-30å²ï¼‰èŒƒå›´å†…ï¼Œæ— æ³•è¯†åˆ«ã€‚";
        operation_advice = "æ­¤æ¨¡å‹ä»…é€‚ç”¨äºZä¸–ä»£ç”¨æˆ·ã€‚";
        confidence = 0;
    }

    document.getElementById('predictResult').innerHTML = `
        <h5>è¯†åˆ«ç»“æœï¼š${group_label}</h5>
        <p><strong>ç½®ä¿¡åº¦ï¼š</strong>${(confidence * 100).toFixed(1)}%</p>
        <p><strong>å®¢ç¾¤æè¿°ï¼š</strong>${group_desc}</p>
        <p><strong>è¿è¥å»ºè®®ï¼š</strong>${operation_advice}</p>
        <details><summary>è¾“å…¥ç‰¹å¾è¯¦æƒ…</summary><pre>${JSON.stringify(inputs, null, 2)}</pre></details>
    `;
    document.getElementById('predictResult').classList.remove('d-none');

    setTimeout(() => {
        document.getElementById('predictBtnText').classList.remove('d-none');
        document.getElementById('predictSpinner').classList.add('d-none');
        document.getElementById('predictBtn').disabled = false;
    }, 800);
});

// éšæœºç”Ÿæˆæ ·æœ¬ï¼ˆä¿æŒä¸å˜ï¼‰
document.getElementById('randomBtn').addEventListener('click', function() {
    document.getElementById('AGE').value = Math.floor(Math.random() * 16) + 15;
    document.getElementById('circle_num').value = Math.floor(Math.random() * 50) + 1;
    document.getElementById('N3M_AVG_DIS_ARPU').value = (Math.random() * 200 + 30).toFixed(1);
    document.getElementById('day_flux').value = (Math.random() * 20 + 0.5).toFixed(1);
    document.getElementById('night_flux').value = (Math.random() * 20 + 0.5).toFixed(1);
    document.getElementById('N3M_AVG_VOICE_SAT').value = Math.floor(Math.random() * 5) + 1;
    document.getElementById('IS_ORD_5G_PACKAGE').value = Math.random() > 0.5 ? "1" : "0";
    document.getElementById('IS_DUALSIM_USER').value = Math.random() > 0.8 ? "1" : "0";
    document.getElementById('IS_TERM_CONTR_USER').value = Math.random() > 0.7 ? "1" : "0";
    document.getElementById('T_school_resident').value = Math.random() > 0.7 ? "1" : "0";
    document.getElementById('T_school_night_resident').value = Math.random() > 0.8 ? "1" : "0";
    document.getElementById('T_company_resident').value = Math.random() > 0.6 ? "1" : "0";
    document.getElementById('N3M_AVG_GAME_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_GAME_APP_USE_CNT').value = Math.floor(Math.random() * 1000);
    document.getElementById('N3M_AVG_GAME_APP_USE_DURA').value = (Math.random() * 100).toFixed(1);
    document.getElementById('N3M_AVG_LEARN_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_LEARN_APP_USE_CNT').value = Math.floor(Math.random() * 500);
    document.getElementById('N3M_AVG_LEARN_APP_USE_DURA').value = (Math.random() * 50).toFixed(1);
    document.getElementById('N3M_AVG_BNK_APP_USE_DAYS').value = Math.floor(Math.random() * 10);
    document.getElementById('N3M_AVG_FINANC_APP_USE_DAYS').value = Math.floor(Math.random() * 10);
    document.getElementById('N3M_AVG_ACCNT_APP_USE_DAYS').value = Math.floor(Math.random() * 10);
    document.getElementById('N3M_AVG_OFFICE_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_EMAIL_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_SOCIAL_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_SOCIAL_APP_USE_CNT').value = Math.floor(Math.random() * 1000);
    document.getElementById('N3M_AVG_READ_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_READ_APP_USE_CNT').value = Math.floor(Math.random() * 500);
    document.getElementById('N3M_AVG_READ_APP_USE_DURA').value = (Math.random() * 50).toFixed(1);
    document.getElementById('N3M_AVG_MUSIC_APP_USE_DAYS').value = Math.floor(Math.random() * 30);
    document.getElementById('N3M_AVG_MUSIC_APP_USE_CNT').value = Math.floor(Math.random() * 1000);
    document.getElementById('N3M_AVG_MUSIC_APP_USE_DURA').value = (Math.random() * 100).toFixed(1);
});

// æ¨¡å‹è¯„ä¼°ï¼ˆä¿æŒä¸å˜ï¼‰
function loadEvalReport() {
    fetch('/api/model/eval')
        .then(res => res.json())
        .then(res => {
            const m = res.data.core_metrics;
            document.getElementById('evalMetrics').innerHTML = `
                <div class="row">
                    <div class="col"><strong>å‡†ç¡®ç‡ï¼š</strong>${m['å‡†ç¡®ç‡(Accuracy)']}</div>
                    <div class="col"><strong>å¬å›ç‡ï¼š</strong>${m['å¬å›ç‡(Recall)']}</div>
                    <div class="col"><strong>F1å€¼ï¼š</strong>${m['F1å€¼(F1-Score)']}</div>
                </div>
            `;
            const tbody = document.getElementById('groupMetricsBody');
            tbody.innerHTML = '';
            res.data.group_metrics.forEach(g => {
                tbody.innerHTML += `<tr>
                    <td>${g.group}</td>
                    <td>${g.precision}</td>
                    <td>${g.recall}</td>
                    <td>${g.f1}</td>
                    <td>${g.support}</td>
                </tr>`;
            });
            document.getElementById('evalConclusion').innerText = res.data.conclusion;
        })
        .catch(() => {
            document.getElementById('evalMetrics').innerHTML = '<div class="text-danger">æ¨¡å‹è¯„ä¼°æ•°æ®åŠ è½½å¤±è´¥</div>';
            document.getElementById('groupMetricsBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted">æ•°æ®åŠ è½½å¤±è´¥</td></tr>';
        });
}

// AI åˆ†æï¼ˆä¿æŒä¸å˜ï¼‰
document.getElementById('aiAnalyzeBtn').addEventListener('click', function() {
    const query = document.getElementById('aiQueryInput').value.trim();
    if (!query) { alert('è¯·è¾“å…¥æ‚¨çš„åˆ†æé—®é¢˜'); return; }

    document.getElementById('aiBtnText').classList.add('d-none');
    document.getElementById('aiSpinner').classList.remove('d-none');
    document.getElementById('aiAnalyzeBtn').disabled = true;

    setTimeout(() => {
        const responses = [
            "åŸºäºæ‚¨è¾“å…¥çš„ç‰¹å¾ï¼Œè¯¥ç”¨æˆ·æå¯èƒ½å±äºâ€˜é«˜æ´»è·ƒæ¸¸æˆé’å¹´â€™å®¢ç¾¤ï¼Œå»ºè®®åŠ å¼ºæ¸¸æˆç”Ÿæ€åˆä½œã€‚",
            "è¯¥ç”¨æˆ·å¤œé—´æµé‡å æ¯”é«˜ã€è§†é¢‘ä½¿ç”¨é¢‘ç¹ï¼Œå¯å½’ç±»ä¸ºâ€˜å¤œé—´å¨±ä¹å‹ç”¨æˆ·â€™ï¼Œé€‚åˆæ¨é€å¤œé—´æµé‡åŒ…ã€‚",
            "æ ¡å›­å¸¸é©»+ä½ARPU+é«˜ç¤¾äº¤ä½¿ç”¨ï¼Œå…¸å‹â€˜å­¦ç”Ÿç¤¾äº¤æ—â€™ï¼Œå»ºè®®æ¨å‡ºæ ¡å›­ç¤¾äº¤å…æµå¥—é¤ã€‚"
        ];
        document.getElementById('aiAnswer').innerText = responses[Math.floor(Math.random() * responses.length)];
        document.getElementById('aiAnswer').classList.remove('d-none');

        document.getElementById('aiBtnText').classList.remove('d-none');
        document.getElementById('aiSpinner').classList.add('d-none');
        document.getElementById('aiAnalyzeBtn').disabled = false;
    }, 1200);
});

document.getElementById('aiQueryInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') document.getElementById('aiAnalyzeBtn').click();
});

// åˆå§‹åŒ–
window.onload = function() {
    loadPortraitData();
    loadEvalReport();
};
</script>
</body>
</html>








